{
    "app-id": "studio.kx.carla",
    "runtime": "org.kde.Platform",
    "runtime-version": "6.2",
    "sdk": "org.kde.Sdk",
    "command": "carla",
    "rename-desktop-file": "carla.desktop",
    "rename-icon": "carla",
    "finish-args": [
        "--share=ipc",
        "--socket=x11",
        "--socket=wayland",
        "--socket=pulseaudio",
        "--device=all",
        "--filesystem=xdg-run/pipewire-0",
        "--filesystem=home",
        "--env=TMPDIR=/var/tmp",
        "--env=ALSA_CONFIG_PATH="
    ],
    "add-extensions": {
        "org.freedesktop.LinuxAudio.Plugins": {
            "directory": "extensions/Plugins",
            "version": "21.08",
            "add-ld-path": "lib",
            "merge-dirs": "ladspa;dssi;lv2;lxvst;vst3",
            "subdirectories": true,
            "no-autodownload": true
        }
    },
    "cleanup": [
        "/include",
        "/man",
        "/share/man",
        "/share/info",
        "/lib/pkgconfig",
        "*.la"
    ],
    "build-options": {
        "env": {
            "PYTHON": "/usr/bin/python3",
            "PIP": "/usr/bin/pip3",
            "PIP_DISABLE_PIP_VERSION_CHECK": "1"
        }
    },
    "modules": [
        "shared-modules/linux-audio/fluidsynth2.json",
        {
            "name": "pyqt",
            "buildsystem": "simple",
            "build-commands": [
                "sh build"
            ],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://files.pythonhosted.org/packages/45/d6/36df7171a4cb00580a608bd92ce085f05fff5e04a74eeac0c52d7de0a584/PyQt6-6.2.3.tar.gz",
                    "sha256": "a9bfcac198fe4b703706f809bb686c7cef5f60a7c802fc145c6b57929c7a6a34",
                    "x-checker-data": {
                        "type": "pypi",
                        "name": "pyqt6"
                    }
                },
                {
                    "type": "file",
                    "path": "pyqt-build",
                    "dest-filename": "build"
                },
                {
                    "type": "shell",
                    "commands": [
                        "echo '[tool.sip.bindings.QtGui]' >> pyproject.toml",
                        "echo 'disabled-features = [\"PyQt_Desktop_OpenGL\"]' >> pyproject.toml"
                    ],
                    "only-arches": [
                        "aarch64"
                    ]
                }
            ],
            "cleanup": [
                "/bin"
            ],
            "modules": [
                {
                    "name": "python-pyparsing",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "cleanup": [
                        "*"
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/d6/60/9bed18f43275b34198eb9720d4c1238c68b3755620d20df0afd89424d32b/pyparsing-3.0.7.tar.gz",
                            "sha256": "18ee9022775d270c55187733956460083db60b37d0d0fb357445f3094eed3eea",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "pyparsing"
                            }
                        }
                    ]
                },
                {
                    "name": "python-packaging",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "cleanup": [
                        "*"
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/df/9e/d1a7217f69310c1db8fdf8ab396229f55a699ce34a203691794c5d1cad0c/packaging-21.3.tar.gz",
                            "sha256": "dd47c42927d89ab911e606518907cc2d3a1f38bbd026385970643f9c5b8ecfeb",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "packaging"
                            }
                        }
                    ]
                },
                {
                    "name": "python-toml",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "cleanup": [
                        "*"
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/be/ba/1f744cdc819428fc6b5084ec34d9b30660f6f9daaf70eead706e3203ec3c/toml-0.10.2.tar.gz",
                            "sha256": "b3bda1d108d5dd99f4a20d24d9c348e91c4db7ab1b749200bded2f839ccbe68f",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "toml"
                            }
                        }
                    ]
                },
                {
                    "name": "sip",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "cleanup": [
                        "*"
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/de/c1/9ac5596c10f6ce28abc1849ed1b6299b3953af0b6ff21e227024991a517e/sip-6.5.1.tar.gz",
                            "sha256": "204f0240db8999a749d638a987b351861843e69239b811ec3d1881412c3706a6",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "sip"
                            }
                        }
                    ]
                },
                {
                    "name": "pyqt-sip",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/61/2b/37c42814d979359c25e5fccd456ac11506fc86d3e6ca0262284a37b71b1e/PyQt6_sip-13.2.1.tar.gz",
                            "sha256": "b7bce59900b2e0a04f70246de2ccf79ee7933036b6b9183cf039b62eeae2b858",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "pyqt6-sip"
                            }
                        }
                    ]
                },
                {
                    "name": "pyqt-builder",
                    "buildsystem": "simple",
                    "build-commands": [
                        "${PIP} install --no-build-isolation --verbose --prefix=${FLATPAK_DEST} ."
                    ],
                    "cleanup": [
                        "*"
                    ],
                    "sources": [
                        {
                            "type": "archive",
                            "url": "https://files.pythonhosted.org/packages/8b/5f/1bd49787262ddce37b826ef49dcccf5a9970facf0ed363dee5ee233e681d/PyQt-builder-1.12.2.tar.gz",
                            "sha256": "f62bb688d70e0afd88c413a8d994bda824e6cebd12b612902d1945c5a67edcd7",
                            "x-checker-data": {
                                "type": "pypi",
                                "name": "pyqt-builder"
                            }
                        }
                    ]
                }
            ]
        },
        {
            "name": "carla",
            "buildsystem": "simple",
            "build-commands": [
                "make features",
                "make PREFIX=/app -j $FLATPAK_BUILDER_N_JOBS",
                "make PREFIX=/app install"
            ],
            "build-options": {
                "arch": {
                    "aarch64": {
                        "env": {
                            "NOOPT": "true"
                        }
                    }
                }
            },
            "post-install": [
                "mv ${FLATPAK_DEST}/bin/carla ${FLATPAK_DEST}/bin/carla.bin",
                "install -Dm755 carla-wrap.sh ${FLATPAK_DEST}/bin/carla",
                "install -Dm644 appdata.xml /app/share/appdata/${FLATPAK_ID}.appdata.xml",
                "install -d /app/extensions/Plugins"
            ],
            "cleanup": [
                "/lib/vst/carla.vst/",
                "/lib/lv2/carla.lv2/"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/falkTX/Carla.git",
                    "tag": "v2.4.1",
                    "commit": "51028655d09c9a21fc51cadd7bc48210295aa791",
                    "x-checker-data": {
                        "type": "git",
                        "tag-pattern": "^v([\\d.]+)$"
                    }
                },
                {
                    "type": "file",
                    "path": "appdata.xml"
                },
                {
                    "type": "file",
                    "path": "carla-wrap.sh"
                }
            ]
        }
    ]
}
